<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel Validation Tool</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    body { background: #f7f8fa; color: #111; font-family: 'Cairo', 'Tajawal', Arial, sans-serif; }
    .main-title { font-weight: 900; font-size: 2.5em; background: linear-gradient(90deg, #FFDE21 0%, #FFD700 100%); border-radius: 18px; padding: 0.5em 1em; box-shadow: 0 4px 32px #ffe06633; display: inline-block; margin-bottom: 0.5em; }
    .main-desc { font-size: 1.2em; margin-bottom: 1.5em; }
    .result-box { background: #fff; border-radius: 14px; padding: 1.2em; margin-bottom: 1.5em; box-shadow: 0 2px 12px #ffe06655; }
    .btn-main { background: linear-gradient(90deg, #21a366 0%, #43c97f 100%); color: #fff; border-radius: 12px; font-weight: bold; border: none; box-shadow: 0 4px 16px #21a36633; padding: 0.75em 2em; font-size: 1.1em; margin-bottom: 12px; letter-spacing: 0.5px; }
    .btn-main:hover { background: linear-gradient(90deg, #43c97f 0%, #21a366 100%); color: #fff; box-shadow: 0 6px 24px #21a36655; transform: scale(1.04); }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="main-title animate__animated animate__fadeInDown">أداة التحقق من ملف إكسل - Excel Validation Tool</div>
    <div class="main-desc animate__animated animate__fadeIn">قم برفع ملف Excel بصيغة xlsx للتحقق من الحقول والقيم وفقًا للقواعد المحددة، ثم تنزيل ملف معدل مع إبراز الأخطاء.</div>
    <form id="uploadForm" enctype="multipart/form-data">
      <div class="mb-3">
        <input class="form-control" type="file" name="file" id="fileInput" accept=".xlsx" required>
      </div>
      <div class="row mb-4" style="justify-content:center;">
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnCheckAll">Check All</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnCheckDate">Check Date Format</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnCheckMandatory">Check Mandatory Fields</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnCheckFinal">Check Final Value</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnSumAsset">Sum Asset Values</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnCheckAssetUsage">Check Asset Usage ID</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnCheckValueBase">Check Value Base</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnCheckMarketApproach">Check Market Approach</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-main" id="btnCheckCostApproach">Check Cost Approach</button>
        </div>
      </div>
    </form>
    <div id="summary" class="result-box" style="display:none;"></div>
    <div id="previewTable" class="table-responsive" style="display:none;"></div>
    <div id="downloadLink" style="display:none;"></div>
  </div>
  <script>
    let lastFile = null;
    document.getElementById('fileInput').addEventListener('change', function(e) {
      lastFile = e.target.files[0];
    });
    async function runCheck(type) {
      if (!lastFile) return;
      const formData = new FormData();
      formData.append('file', lastFile);
      document.getElementById('summary').style.display = 'block';
      document.getElementById('summary').innerHTML = 'جاري التحقق من الملف...';
      document.getElementById('previewTable').style.display = 'none';
      document.getElementById('downloadLink').style.display = 'none';
      try {
        // Preview and summary fetch
        const previewResp = await fetch('/validate-preview?type=' + type, {
          method: 'POST',
          body: formData
        });
        if (!previewResp.ok) throw new Error('فشل التحقق من الملف');
        const { header, preview, summary, total } = await previewResp.json();
        // Show summary
        let summaryHtml = '';
        if (summary.length > 0) {
          // Only one message and it's success
          if (summary.length === 1 && summary[0].startsWith('✅')) {
            summaryHtml = `<div style='background:linear-gradient(90deg,#eafaf1,#d4f5e9);color:#218838;font-weight:bold;border-radius:10px;padding:16px 22px;margin-bottom:10px;display:flex;align-items:center;box-shadow:0 2px 8px #21a36622;font-size:1.2em;'><span style='font-size:1.7em;margin-left:14px;'>✅</span> <span>${summary[0].replace('✅','')}</span></div>`;
          } else {
            summaryHtml = `<div style='font-size:1.2em;font-weight:bold;margin-bottom:10px;'>الملخص:</div><div style='margin-top:0;'>` + summary.map((s, idx) => {
              if (s.startsWith('✅')) {
                return `<div style='background:linear-gradient(90deg,#eafaf1,#d4f5e9);color:#218838;font-weight:bold;border-radius:10px;padding:10px 18px;margin-bottom:10px;display:flex;align-items:center;box-shadow:0 2px 8px #21a36622;'><span style='font-size:1.5em;margin-left:12px;'>✅</span> <span>${s.replace('✅','')}</span></div>`;
              } else if (s.startsWith('❌')) {
                // Extract number of errors if present
                const match = s.match(/(\d+)/);
                let count = match ? match[1] : '';
                let note = '';
                if (s.includes('Missing mandatory values')) note = '↳ يجب ملء جميع الحقول المشار اليها وعدم تركها فارغه.';
                else if (s.includes('Final Value issues') || s.includes('final_value')) note = '↳ يجب أن تكون القيمة عددًا صحيحًا بدون كسور.';
                else if (s.includes('inspection_date')) note = '↳ يجب ان يكون التاريخ في هذا التنسيق dd-mm-YYYY الخاص بعمود inspection_date';
                else if (s.includes('asset_usage_id')) note = '↳ يجب أن تكون جميع القيم في هذا الحقل بين 38 و 56.';
                else if (s.includes('value_base')) note = '↳ يجب أن تكون جميع القيم في هذا الحقل بين 1 و 9.';
                else if (s.includes('market_approach')) note = '↳ يجب أن تكون القيم في هذا الحقل 0 أو 1 أو 2، وإذا كانت 1 أو 2 يجب أن يكون market_approach_value مساويًا لـ final_value.';
                else if (s.includes('cost_approach')) note = '↳ إذا كان market_approach = 0 يجب أن يكون cost_approach = 1 أو 2، وإذا كان 1 أو 2 يجب أن يكون cost_approach_value مساويًا لـ final_value.';
                // Always show a note for every error, even if not a known type
                if (!note) note = '↳ يرجى ملئ جميع الحقول الفارغه وتأكد من صحة البيانات.';
                return `<div style='background:linear-gradient(90deg,#fff3f3,#ffeaea);color:#a80000;font-weight:bold;border-radius:10px;padding:10px 18px;margin-bottom:10px;display:flex;align-items:center;box-shadow:0 2px 8px #ff000022;flex-direction:column;'><div style='display:flex;align-items:center;width:100%;'><span style='font-size:1.5em;margin-left:12px;'>❌</span> <span>${s.replace('❌','')}${count ? ` <span style='background:#fff0f0;color:#a80000;border-radius:6px;padding:2px 10px;margin-right:10px;font-size:1em;'>عدد الخلايا: ${count}</span>` : ''}</span></div>${note ? `<div style='background:linear-gradient(90deg,#f8d7da,#fff);color:#a80000;border-radius:7px;padding:7px 18px 7px 12px;margin-top:7px;font-size:0.98em;'><b>ملاحظة:</b> ${note.replace('↳','')}</div>` : ''}</div>`;
              }
            }).join('') + '</div>';
          }
        }
        if (typeof total !== 'undefined' && total !== null) {
          summaryHtml += `<div style='margin-top:18px;'><b>مجموع final_value:</b> <span style='font-size:2.2em; color:#21a366;font-weight:bold;'>${Number(total).toLocaleString('en')}</span></div>`;
        }
        document.getElementById('summary').style.display = 'block';
        document.getElementById('summary').innerHTML = summaryHtml;
        // Show preview table
        let table = '<table class="table table-bordered table-striped"><thead><tr>';
        header.forEach(col => { table += `<th>${col}</th>`; });
        table += '</tr></thead><tbody>';
        preview.forEach(row => {
          table += '<tr>';
          header.forEach(col => {
            const cell = row[col];
            if (cell.highlight) {
              table += `<td style="background:#FFDE21; color:#111; font-weight:bold;">${cell.value}</td>`;
            } else {
              table += `<td>${cell.value}</td>`;
            }
          });
          table += '</tr>';
        });
        table += '</tbody></table>';
        document.getElementById('previewTable').innerHTML = table;
        document.getElementById('previewTable').style.display = 'block';
        // Download button logic (unchanged)
        const downloadResp = await fetch('/validate?type=' + type, {
          method: 'POST',
          body: formData
        });
        if (!downloadResp.ok) throw new Error('فشل إنشاء الملف المعدل');
        const blob = await downloadResp.blob();
        const url = window.URL.createObjectURL(blob);
        document.getElementById('downloadLink').innerHTML = `<a href="${url}" download="validated.xlsx" class="btn btn-main">تنزيل الملف المعدل</a>`;
        document.getElementById('downloadLink').style.display = 'block';
      } catch (err) {
        document.getElementById('summary').innerHTML = 'حدث خطأ أثناء التحقق: ' + err.message;
        document.getElementById('previewTable').style.display = 'none';
      }
    }
    document.getElementById('btnCheckAll').onclick = () => {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      runCheck('all');
    };
    document.getElementById('btnCheckDate').onclick = () => {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      runCheck('date');
    };
    document.getElementById('btnCheckMandatory').onclick = () => {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      runCheck('mandatory');
    };
    document.getElementById('btnCheckFinal').onclick = () => {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      runCheck('final');
    };
    document.getElementById('btnSumAsset').onclick = async function() {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      const formData = new FormData();
      formData.append('file', lastFile);
      try {
        const resp = await fetch('/validate-preview?type=sum', { method: 'POST', body: formData });
        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.error || 'فشل حساب المجموع');
        }
        const { total } = await resp.json();
        document.getElementById('summary').innerHTML = `<b>مجموع final_value:</b> <span style='font-size:2em; color:#21a366;'>${Number(total).toLocaleString('en')}</span>`;
        document.getElementById('summary').style.display = 'block';
        document.getElementById('previewTable').style.display = 'none';
        document.getElementById('downloadLink').style.display = 'none';
      } catch (err) {
        document.getElementById('summary').innerHTML = 'حدث خطأ أثناء الحساب: ' + err.message;
        document.getElementById('summary').style.display = 'block';
        document.getElementById('previewTable').style.display = 'none';
        document.getElementById('downloadLink').style.display = 'none';
      }
    };
    document.getElementById('btnCheckAssetUsage').onclick = () => {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      runCheck('asset_usage');
    };
    document.getElementById('btnCheckValueBase').onclick = () => {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      runCheck('value_base');
    };
    document.getElementById('btnCheckMarketApproach').onclick = () => {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      runCheck('market_approach');
    };
    document.getElementById('btnCheckCostApproach').onclick = () => {
      if (!lastFile) {
        document.getElementById('summary').innerHTML = '<span style="color:#a80000;font-weight:bold;">يرجى رفع ملف Excel أولاً.</span>';
        document.getElementById('summary').style.display = 'block';
        return;
      }
      runCheck('cost_approach');
    };
  </script>
</body>
</html>
